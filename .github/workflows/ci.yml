name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0
  KUBECTL_VERSION: 1.28.0

jobs:
  # Job 1: Validate and Test
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black

      - name: Lint with flake8
        run: |
          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src --count --max-complexity=10 --max-line-length=120 --statistics

      - name: Check code formatting with black
        run: black --check src

      - name: Validate Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: infrastructure/terraform-eks
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: infrastructure/terraform-eks
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: infrastructure/terraform-eks
        run: terraform validate

  # Job 2: Build and Push Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action != 'destroy'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata for Docker
        id: meta
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${TIMESTAMP}-${SHORT_SHA}"
          echo "tags=${{ steps.login-ecr.outputs.registry }}/fictions-api-development:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "latest=${{ steps.login-ecr.outputs.registry }}/fictions-api-development:latest" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build -t ${{ steps.meta.outputs.tags }} .
          docker tag ${{ steps.meta.outputs.tags }} ${{ steps.meta.outputs.latest }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy vulnerability scanner (Table format)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail the build, just report

      - name: Push Docker image
        run: |
          docker push ${{ steps.meta.outputs.tags }}
          docker push ${{ steps.meta.outputs.latest }}

      - name: Image digest
        run: echo "Image pushed with tag ${{ steps.meta.outputs.tags }}"

  # Job 3: Deploy Infrastructure with Terraform
  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.action != 'destroy'
    
    outputs:
      cluster-name: ${{ steps.terraform-output.outputs.cluster_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: infrastructure/terraform-eks
        run: terraform init

      - name: Terraform Plan
        working-directory: infrastructure/terraform-eks
        run: |
          terraform plan \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infrastructure/terraform-eks
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: terraform-output
        working-directory: infrastructure/terraform-eks
        run: |
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          echo "cluster_name=${CLUSTER_NAME}" >> $GITHUB_OUTPUT
          terraform output > outputs.txt

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v3
        with:
          name: terraform-outputs
          path: infrastructure/terraform-eks/outputs.txt

  # Job 4: Deploy to Kubernetes
  deploy-k8s:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build, deploy-infra]
    if: github.event.inputs.action != 'destroy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v${{ env.KUBECTL_VERSION }}'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ needs.deploy-infra.outputs.cluster-name }}

      - name: Verify cluster connection
        run: kubectl get nodes

      - name: Get ECR URL
        id: ecr-url
        run: |
          ECR_URL=$(aws ecr describe-repositories \
            --repository-names fictions-api-development \
            --region ${{ env.AWS_REGION }} \
            --query 'repositories[0].repositoryUri' \
            --output text)
          echo "ecr_url=${ECR_URL}" >> $GITHUB_OUTPUT

      - name: Update Kubernetes deployment with image
        run: |
          sed -i "s|image:.*|image: ${{ steps.ecr-url.outputs.ecr_url }}:latest|g" kubernetes/deployment.yaml

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f kubernetes/namespace.yaml
          kubectl apply -f kubernetes/configmap.yaml
          kubectl apply -f kubernetes/secrets.yaml
          kubectl apply -f kubernetes/mongodb.yaml
          kubectl apply -f kubernetes/deployment.yaml
          kubectl apply -f kubernetes/service.yaml
          kubectl apply -f kubernetes/hpa.yaml

      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/fictions-api -n fictions-app --timeout=300s
          kubectl rollout status statefulset/mongodb -n fictions-app --timeout=300s

      - name: Get LoadBalancer URL
        id: get-url
        run: |
          echo "Waiting for LoadBalancer to be ready..."
          sleep 60
          LB_URL=$(kubectl get svc fictions-api -n fictions-app \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "api_url=http://${LB_URL}" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** http://${LB_URL}" >> $GITHUB_STEP_SUMMARY
          echo "**Swagger UI:** http://${LB_URL}/api/docs" >> $GITHUB_STEP_SUMMARY

      - name: Check application health
        run: |
          echo "Waiting for application to be ready..."
          sleep 30
          kubectl get pods -n fictions-app
          
      - name: Display deployment info
        run: |
          echo "==================================================="
          echo "ðŸŽ‰ Deployment Complete!"
          echo "==================================================="
          echo "API URL: ${{ steps.get-url.outputs.api_url }}"
          echo "Swagger UI: ${{ steps.get-url.outputs.api_url }}/api/docs"
          echo "==================================================="

  # Job 5: Manual Approval for Destroy
  approval:
    name: Approve Destruction
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    environment:
      name: production-destroy
    
    steps:
      - name: Wait for approval
        run: |
          echo "âš ï¸  Waiting for manual approval to destroy infrastructure..."
          echo "This will delete ALL resources including:"
          echo "  - EKS Cluster"
          echo "  - VPC and all networking"
          echo "  - Load Balancers"
          echo "  - ECR repositories"
          echo "  - All data will be LOST"

  # Job 6: Destroy Kubernetes Resources
  destroy-k8s:
    name: Destroy Kubernetes Resources
    runs-on: ubuntu-latest
    needs: approval
    if: github.event.inputs.action == 'destroy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform (to get cluster name)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Get cluster name
        id: cluster-info
        working-directory: infrastructure/terraform-eks
        run: |
          terraform init
          CLUSTER_NAME=$(terraform output -raw cluster_name || echo "fictions-api-development")
          echo "cluster_name=${CLUSTER_NAME}" >> $GITHUB_OUTPUT

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v${{ env.KUBECTL_VERSION }}'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ steps.cluster-info.outputs.cluster_name }} || true

      - name: Delete Kubernetes resources
        run: |
          kubectl delete -f kubernetes/ --ignore-not-found=true || true
          kubectl delete namespace fictions-app --ignore-not-found=true || true

      - name: Wait for resources to be deleted
        run: |
          echo "Waiting for LoadBalancer to be deleted..."
          sleep 60

  # Job 7: Destroy Infrastructure
  destroy-infra:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: destroy-k8s
    if: github.event.inputs.action == 'destroy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: infrastructure/terraform-eks
        run: terraform init

      - name: Terraform Destroy
        working-directory: infrastructure/terraform-eks
        run: |
          terraform destroy \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -auto-approve

      - name: Cleanup summary
        run: |
          echo "### ðŸ—‘ï¸ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All AWS resources have been deleted:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kubernetes resources deleted" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EKS cluster destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VPC and networking destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Load balancers removed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All data deleted" >> $GITHUB_STEP_SUMMARY

  # Job 8: Cleanup ECR (optional)
  cleanup-ecr:
    name: Cleanup ECR Images
    runs-on: ubuntu-latest
    needs: destroy-infra
    if: github.event.inputs.action == 'destroy'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete ECR repository
        run: |
          aws ecr delete-repository \
            --repository-name fictions-api-development \
            --region ${{ env.AWS_REGION }} \
            --force || echo "ECR repository already deleted or doesn't exist"

      - name: Final cleanup summary
        run: |
          echo "### âœ… Complete Cleanup Finished" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All resources have been removed." >> $GITHUB_STEP_SUMMARY
          echo "No AWS charges will incur." >> $GITHUB_STEP_SUMMARY

